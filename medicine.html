<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>약 알리미</title>
    <link rel="icon" href="./image/bimoicon.png" />
    <link rel="stylesheet" href="/style/medicine.css" />
  </head>
  <body>
    <div id="wrap">
      <div
        id="backButton"
        style="position: absolute; top: 10px; left: 10px; cursor: pointer"
      >
        <span style="font-size: 20px">← 뒤로가기</span>
      </div>
      <div class="time-picker">
        <div class="picker" id="ampmPicker">
          <ul>
            <li>오전</li>
            <li>오후</li>
          </ul>
        </div>
        <div class="picker" id="hourPicker">
          <ul id="hourSettings"></ul>
        </div>
        <span>:</span>
        <div class="picker" id="minutePicker">
          <ul id="minuteSettings"></ul>
        </div>
        <button class="time-picker__button" id="setAlarmButton">저장</button>
      </div>

      <form id="alarmForm">
        <label for="alarmDays">요일:</label>
        <div id="alarmDays">
          <label><input type="checkbox" value="1" />월요일</label>
          <label><input type="checkbox" value="2" />화요일</label>
          <label><input type="checkbox" value="3" />수요일</label>
          <label><input type="checkbox" value="4" />목요일</label>
          <label><input type="checkbox" value="5" />금요일</label>
          <label class="saturday"
            ><input type="checkbox" value="6" />토요일</label
          >
          <label class="monday"
            ><input type="checkbox" value="0" />일요일</label
          >
        </div>
      </form>

      <div id="alarmList">
        <h3>설정된 알람</h3>
        <ul id="alarmItems"></ul>
      </div>

      <!-- 음성 파일 -->
      <audio id="alarmSound" src="./assets/music/"></audio>
    </div>

    <script>
      document.querySelector("#backButton").addEventListener("click", () => {
        window.history.back();
      });
      document
        .querySelector("#backButton")
        .addEventListener("tourhstrat", () => {
          window.history.back();
        });
      const hourSettings = document.querySelector("#hourSettings");
      const minuteSettings = document.querySelector("#minuteSettings");

      for (let i = 1; i < 13; i++) {
        const hourItem = document.createElement("li");
        hourItem.textContent = i.toString();
        hourSettings.appendChild(hourItem);
      }

      for (let i = 0; i < 60; i++) {
        const minuteItem = document.createElement("li");
        minuteItem.textContent = i.toString().padStart(2, "0");
        minuteSettings.appendChild(minuteItem);
      }

      function initPicker(pickerId, initialIndex) {
        const picker = document.getElementById(pickerId);
        const ul = picker.querySelector("ul");
        const liElements = ul.querySelectorAll("li");

        let selectedIndex = initialIndex;
        let startY = 0;
        let currentY = 0;
        let isDragging = false;

        ul.style.top = `-${selectedIndex * 50}px`;

        picker.addEventListener("wheel", (event) => {
          event.preventDefault();
          handleScroll(event.deltaY > 0 ? 1 : -1);
        });

        picker.addEventListener("touchstart", (event) => {
          startY = event.touches[0].clientY;
          isDragging = true;
        });

        picker.addEventListener("touchmove", (event) => {
          if (!isDragging) return;
          currentY = event.touches[0].clientY;
          const deltaY = startY - currentY;

          if (Math.abs(deltaY) > 10) {
            handleScroll(deltaY > 0 ? 1 : -1);
            startY = currentY;
          }
        });

        picker.addEventListener("touchend", () => {
          isDragging = false;
        });

        function handleScroll(direction) {
          if (
            selectedIndex + direction >= 0 &&
            selectedIndex + direction < liElements.length
          ) {
            selectedIndex += direction;
            ul.style.top = `-${selectedIndex * 50}px`;
            updateSelectedClass(liElements, selectedIndex);
          }
        }

        function updateSelectedClass(elements, selectedIndex) {
          elements.forEach((li, index) => {
            li.classList.toggle("selected", index === selectedIndex);
          });
        }

        updateSelectedClass(liElements, selectedIndex);
      }

      initPicker("hourPicker", 0); // 1시가 첫 번째 항목이므로 0
      initPicker("minutePicker", 0); // 00분이 첫 번째 항목이므로 0
      initPicker("ampmPicker", 0); // 오전이 첫 번째 항목이므로 0

      document
        .getElementById("setAlarmButton")
        .addEventListener("click", function () {
          const alarmDays = Array.from(
            document.querySelectorAll("#alarmDays input:checked")
          ).map((input) => parseInt(input.value));

          let alarmDaysText;
          if (alarmDays.length === 0) {
            alarmDays.push(0, 1, 2, 3, 4, 5, 6);
            alarmDaysText = "매일";
          } else {
            alarmDaysText = alarmDays
              .map((day) => ["일", "월", "화", "수", "목", "금", "토"][day])
              .join(", ");
          }

          const selectedAmPm = document
            .querySelector("#ampmPicker .selected")
            .textContent.trim();
          const selectedHour = document
            .querySelector("#hourPicker .selected")
            .textContent.trim();
          const selectedMinute = document
            .querySelector("#minutePicker .selected")
            .textContent.trim();

          const alarmTime = `${selectedAmPm} ${selectedHour}:${selectedMinute}`;
          const alarmText = `시간: ${alarmTime}, 요일: ${alarmDaysText}`;

          const alarmItems = document.getElementById("alarmItems");

          let isDuplicate = false;
          const existingAlarms = alarmItems.querySelectorAll("li");
          existingAlarms.forEach((alarm) => {
            if (alarm.textContent === alarmText) {
              isDuplicate = true;
            }
          });

          if (isDuplicate) {
            alert("이미 동일한 시간과 요일로 알람이 설정되어 있습니다.");
          } else {
            const listItem = document.createElement("li");
            listItem.textContent = alarmText;

            // 삭제 버튼 추가
            const deleteButton = document.createElement("button");
            deleteButton.textContent = "삭제";
            deleteButton.addEventListener("click", () => {
              alarmItems.removeChild(listItem);
            });

            listItem.appendChild(deleteButton);
            alarmItems.appendChild(listItem);
          }
        });

      function checkAlarms() {
        const currentDate = new Date();
        const currentDay = currentDate.getDay();
        const currentHour = currentDate.getHours();
        const currentMinute = currentDate.getMinutes();
        const currentAmPm = currentHour >= 12 ? "오후" : "오전";
        const adjustedHour = currentHour % 12 || 12;

        const currentTimeText = `${currentAmPm} ${adjustedHour}:${currentMinute
          .toString()
          .padStart(2, "0")}`;

        const alarmItems = document
          .getElementById("alarmItems")
          .querySelectorAll("li");
        alarmItems.forEach((alarm) => {
          if (alarm.textContent.includes(currentTimeText)) {
            if (
              alarm.textContent.includes("매일") ||
              alarm.textContent.includes(
                ["일", "월", "화", "수", "목", "금", "토"][currentDay]
              )
            ) {
              console.log(`알람: ${alarm.textContent}`);
              document.getElementById("alarmSound").play();
            }
          }
        });
      }

      setInterval(checkAlarms, 60000); // 1분마다 체크
    </script>
  </body>
</html>
